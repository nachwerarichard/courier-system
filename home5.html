/**
 * COURIER SYSTEM DASHBOARD CORE LOGIC
 * Follows Flow 1-7 and Database Schema
 */

const state = {
    staff: {
        name: localStorage.getItem('staffName') || "Musa Clerk",
        station: localStorage.getItem('staffStation') || "Mbale",
        role: localStorage.getItem('staffRole') || "clerk"
    },
    parcels: [
        { id: 1, tracking: "TRK-2201", sender: "Ivan Kato", receiver: "Grace Nam", destination: "Kampala", status: "In Transit", payment: "Paid", total: 45000, paid: 45000, balance: 0 },
        { id: 2, tracking: "TRK-2202", sender: "Ali Sula", receiver: "Bob Okello", destination: "Mbale", status: "At Dispatch", payment: "Unpaid", total: 30000, paid: 0, balance: 30000 }
    ],
    clients: []
};

// 1. Initialize System
function init() {
    document.getElementById('staff-name-display').innerText = state.staff.name;
    document.getElementById('staff-station-display').innerText = `STATION: ${state.staff.station}`;
    
    if(state.staff.role === 'admin') {
        document.getElementById('admin-menu').classList.remove('hidden');
    }

    renderTable();
    updateStats();
}

// 2. Render Table with Status Color-Coding
function renderTable() {
    const tbody = document.getElementById('parcelTableBody');
    tbody.innerHTML = "";

    state.parcels.forEach(p => {
        const row = `
            <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-6 py-4 font-mono font-bold text-blue-600">${p.tracking}</td>
                <td class="px-6 py-4">
                    <div class="font-bold">${p.sender}</div>
                    <div class="text-[10px] text-gray-400">To: ${p.receiver}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="text-xs font-medium text-slate-500">${state.staff.station} &rarr; ${p.destination}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-[10px] font-black uppercase ${p.payment === 'Paid' ? 'text-green-600' : 'text-red-500'}">${p.payment}</span>
                    <div class="text-[10px] text-gray-400 italic">Bal: UGX ${p.balance.toLocaleString()}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${getStatusStyle(p.status)}">
                        ${p.status}
                    </span>
                </td>
                <td class="px-6 py-4 flex gap-2">
                    ${getActionButtons(p)}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// 3. Flow Logic: Status Updates
function getStatusStyle(status) {
    switch(status) {
        case 'At Dispatch': return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
        case 'In Transit': return 'bg-green-100 text-green-700 border border-green-200';
        case 'Ready for Pickup': return 'bg-blue-100 text-blue-700 border border-blue-200';
        case 'Delivered': return 'bg-orange-100 text-orange-700 border border-orange-200';
        default: return 'bg-gray-100';
    }
}

function getActionButtons(p) {
    if(p.status === 'At Dispatch') return `<button onclick="updateStatus(${p.id}, 'In Transit')" class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold">SEND</button>`;
    if(p.status === 'In Transit' && p.destination === state.staff.station) return `<button onclick="updateStatus(${p.id}, 'Ready for Pickup')" class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold">ARRIVE</button>`;
    if(p.status === 'Ready for Pickup') return `<button onclick="handleDelivery(${p.id})" class="bg-orange-500 text-white px-2 py-1 rounded text-[10px] font-bold">PICKUP</button>`;
    return `<button class="text-slate-400 text-xs italic" disabled>Complete</button>`;
}

function updateStatus(id, newStatus) {
    const parcel = state.parcels.find(p => p.id === id);
    if(parcel) {
        parcel.status = newStatus;
        // Logic for history recording would trigger here
        renderTable();
        updateStats();
    }
}

// 4. Delivery Confirmation
function handleDelivery(id) {
    const parcel = state.parcels.find(p => p.id === id);
    if(parcel.balance > 0) {
        alert(`Cannot Deliver. Outstanding Balance: UGX ${parcel.balance}`);
        return;
    }
    updateStatus(id, 'Delivered');
}

// 5. Create Parcel Logic
document.getElementById('parcelForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const total = parseFloat(document.getElementById('pTotal').value);
    const paid = parseFloat(document.getElementById('pPaid').value || 0);
    const balance = total - paid;
    
    const newParcel = {
        id: Date.now(),
        tracking: `TRK-${Math.floor(1000 + Math.random() * 9000)}`,
        sender: "Selected Client", // This would pull from Flow 2 logic
        receiver: document.getElementById('pReceiver').value,
        destination: document.getElementById('pDest').value,
        status: "At Dispatch",
        payment: document.getElementById('pPayStatus').value,
        total: total,
        paid: paid,
        balance: balance
    };

    state.parcels.unshift(newParcel);
    hideModal('parcelModal');
    showReceipt(newParcel);
    renderTable();
    updateStats();
});

// 6. Receipt Generation (Confirm Receipt)
function showReceipt(p) {
    document.getElementById('rStation').innerText = `${state.staff.station} Station`;
    document.getElementById('rTrk').innerText = p.tracking;
    document.getElementById('rSnd').innerText = p.sender;
    document.getElementById('rRcv').innerText = p.receiver;
    document.getElementById('rDest').innerText = p.destination;
    document.getElementById('rTotal').innerText = p.total.toLocaleString();
    document.getElementById('rPaid').innerText = p.paid.toLocaleString();
    document.getElementById('rBal').innerText = p.balance.toLocaleString();
    showModal('receiptModal');
}

// Helper Functions
function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
function updateStats() {
    document.getElementById('stat-total').innerText = state.parcels.length;
    document.getElementById('stat-transit').innerText = state.parcels.filter(p => p.status === 'In Transit').length;
    document.getElementById('stat-pickup').innerText = state.parcels.filter(p => p.status === 'Ready for Pickup').length;
    document.getElementById('stat-delivered').innerText = state.parcels.filter(p => p.status === 'Delivered').length;
}

init();
